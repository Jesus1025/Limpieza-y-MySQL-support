<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes - DEV</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users"></i> Gestión de Clientes (DEV)
                </h1>
                <p class="text-muted mt-1">Administra la información de tus clientes</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalClienteNuevo">
                    <i class="fas fa-plus-circle"></i> Nuevo Cliente
                </button>
            </div>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="buscarCliente" class="form-control border-0 bg-light" 
                                   placeholder="Buscar por RUT, nombre o email...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Clientes -->
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" id="tablaClientes">
                    <thead class="table-light">
                        <tr>
                            <th class="fw-600">RUT</th>
                            <th class="fw-600">Razón Social</th>
                            <th class="fw-600">Email</th>
                            <th class="fw-600">Teléfono</th>
                            <th class="fw-600">Giro</th>
                            <th class="fw-600">Banco</th>
                            <th class="fw-600">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaClientes">
                        <!-- Se llena con JavaScript -->
                    </tbody>
                </table>
                <div id="sinResultados" class="text-center p-5 text-muted" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p class="fs-5">No hay clientes que coincidan con tu búsqueda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo/Editar Cliente -->
    <div class="modal fade" id="modalClienteNuevo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-600">
                        <i class="fas fa-user-plus"></i> <span id="modalTitulo">Nuevo Cliente</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="formCliente">
                        <!-- RUT y Razón Social -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">RUT *</label>
                                <input type="text" class="form-control" id="clienteRut" 
                                       placeholder="12.345.678-9" required>
                                <small class="text-muted">Formato: XX.XXX.XXX-X</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Razón Social *</label>
                                <input type="text" class="form-control" id="clienteRazonSocial" 
                                       placeholder="Nombre de la empresa" required>
                            </div>
                        </div>

                        <!-- Email y Teléfono -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">Email *</label>
                                <input type="email" class="form-control" id="clienteEmail" 
                                       placeholder="contacto@empresa.com" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Teléfono</label>
                                <input type="tel" class="form-control" id="clienteTelefono" 
                                       placeholder="+56 9 XXXX XXXX">
                            </div>
                        </div>

                        <!-- Giro y Dirección -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">Giro</label>
                                <input type="text" class="form-control" id="clienteGiro" 
                                       placeholder="Ej: Tecnología, Software...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Dirección</label>
                                <input type="text" class="form-control" id="clienteDireccion" 
                                       placeholder="Calle y número">
                            </div>
                        </div>

                        <!-- Comuna y Banco -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">Comuna</label>
                                <input type="text" class="form-control" id="clienteComuna" 
                                       placeholder="Ej: Santiago">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Banco</label>
                                <input type="text" class="form-control" id="clienteBanco" 
                                       placeholder="Ej: Banco de Chile">
                            </div>
                        </div>

                        <!-- Cuenta Corriente -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-500">Número de Cuenta Corriente</label>
                                <input type="text" class="form-control" id="clienteCuentaCorriente" 
                                       placeholder="Ej: 1234567890">
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-500">Observaciones</label>
                                <textarea class="form-control" id="clienteObservaciones" rows="3" 
                                          placeholder="Notas adicionales sobre el cliente..."></textarea>
                            </div>
                        </div>

                        <!-- Alertas -->
                        <div id="alertasFormulario"></div>

                        <!-- Botones -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> <span id="btnGuardarTexto">Guardar Cliente</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Versión simplificada para desarrollo sin autenticación
        let clientesActuales = [];

        document.addEventListener('DOMContentLoaded', function() {
            console.log('✓ Página de desarrollo cargada');
            cargarClientes();
            document.getElementById('formCliente').addEventListener('submit', guardarCliente);
            document.getElementById('buscarCliente').addEventListener('input', filtrarClientes);
            document.getElementById('modalClienteNuevo').addEventListener('hidden.bs.modal', limpiarFormulario);
        });

        function cargarClientes() {
            console.log('► Cargando clientes desde /api/clientes-dev');
            fetch('/api/clientes-dev')
                .then(r => {
                    console.log('Status:', r.status);
                    if (!r.ok) throw new Error('Error ' + r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('✓ Clientes recibidos:', data.length);
                    clientesActuales = Array.isArray(data) ? data : [];
                    renderizarClientes(clientesActuales);
                })
                .catch(e => {
                    console.error('✗ Error:', e);
                    alert('Error al cargar clientes: ' + e);
                });
        }

        function renderizarClientes(clientes) {
            console.log('✓ Renderizando', clientes.length, 'clientes');
            const tbody = document.getElementById('cuerpoTablaClientes');
            const sinResultados = document.getElementById('sinResultados');
            
            if (!clientes || clientes.length === 0) {
                tbody.innerHTML = '';
                sinResultados.style.display = 'block';
                return;
            }
            
            sinResultados.style.display = 'none';
            tbody.innerHTML = clientes.map(c => `
                <tr>
                    <td>${c.rut}</td>
                    <td>${c.razon_social}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.telefono || '-'}</td>
                    <td>${c.giro || '-'}</td>
                    <td>${c.banco || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="eliminarCliente('${c.rut}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filtrarClientes() {
            const busqueda = document.getElementById('buscarCliente').value.toLowerCase();
            const filtrados = clientesActuales.filter(c =>
                c.rut.includes(busqueda) || c.razon_social.toLowerCase().includes(busqueda)
            );
            renderizarClientes(filtrados);
        }

        function guardarCliente(e) {
            e.preventDefault();
            const datos = {
                rut: document.getElementById('clienteRut').value,
                razon_social: document.getElementById('clienteRazonSocial').value,
                email: document.getElementById('clienteEmail').value,
                telefono: document.getElementById('clienteTelefono').value,
                giro: document.getElementById('clienteGiro').value,
                direccion: document.getElementById('clienteDireccion').value,
                comuna: document.getElementById('clienteComuna').value,
                banco: document.getElementById('clienteBanco').value,
                cuenta_corriente: document.getElementById('clienteCuentaCorriente').value,
                observaciones: document.getElementById('clienteObservaciones').value,
            };
            
            console.log('► Guardando cliente:', datos);
            fetch('/api/clientes-dev', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            })
            .then(r => r.json())
            .then(data => {
                console.log('✓ Respuesta:', data);
                if (data.success) {
                    alert('✓ ' + data.message);
                    bootstrap.Modal.getInstance(document.getElementById('modalClienteNuevo')).hide();
                    cargarClientes();
                    limpiarFormulario();
                } else {
                    alert('✗ Error: ' + data.error);
                }
            })
            .catch(e => alert('✗ Error: ' + e));
        }

        function eliminarCliente(rut) {
            if (!confirm('¿Eliminar cliente ' + rut + '?')) return;
            console.log('► Eliminando cliente:', rut);
            fetch('/api/clientes-dev?rut=' + encodeURIComponent(rut), { method: 'DELETE' })
                .then(r => r.json())
                .then(data => {
                    console.log('✓ Respuesta:', data);
                    if (data.success) {
                        alert('✓ Cliente eliminado');
                        cargarClientes();
                    } else {
                        alert('✗ Error al eliminar');
                    }
                })
                .catch(e => alert('✗ Error: ' + e));
        }

        function limpiarFormulario() {
            document.getElementById('formCliente').reset();
            document.getElementById('clienteRut').readOnly = false;
            document.getElementById('alertasFormulario').innerHTML = '';
            document.getElementById('modalTitulo').textContent = 'Nuevo Cliente';
            document.getElementById('btnGuardarTexto').textContent = 'Guardar Cliente';
        }
    </script>
</body>
</html>
