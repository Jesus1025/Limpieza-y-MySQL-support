<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Clientes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body data-user-role="{{ session.rol }}">
    {% extends "base.html" %}

    {% block title %}Gestión de Clientes{% endblock %}

    {% block content %}
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users"></i> Gestión de Clientes
                </h1>
                <p class="text-muted mt-1 mb-0">Mostrando <strong id="clientesCount">0</strong> clientes</p>
                <p class="text-muted mt-1">Administra la información de tus clientes</p>
            </div>
            <div class="col-md-4 text-end">
                {% if session.rol in ['admin', 'usuario'] %}
                <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#modalClienteNuevo">
                    <i class="fas fa-plus-circle"></i> Nuevo Cliente
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Filtros y Búsqueda -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="buscarCliente" class="form-control border-0 bg-light" 
                                   placeholder="Buscar por RUT, nombre o email...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select id="filtroEstado" class="form-select bg-light border-0">
                            <option value="">Todos los estados</option>
                            <option value="activo" selected>Activos</option>
                            <option value="inactivo">Inactivos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                            <i class="fas fa-redo"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
                <div id="clientesDebug" class="px-4 pb-3"></div>
            </div>
        </div>

        <!-- Tabla de Clientes -->
        <div class="card shadow-sm border-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" id="tablaClientes">
                    <thead class="table-light">
                        <tr>
                            <th class="fw-600">RUT</th>
                            <th class="fw-600">Razón Social</th>
                            <th class="fw-600">Email</th>
                            <th class="fw-600">Teléfono</th>
                            <th class="fw-600">Giro</th>
                            <th class="fw-600">Banco</th>
                            <th class="fw-600">Estado</th>
                            <th class="fw-600">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTablaClientes">
                        {# Renders initial rows server-side so page shows content even if JS falla #}
                        {% for cliente in clientes %}
                        <tr>
                            <td class="fw-500">{{ cliente.rut }}</td>
                            <td>{{ cliente.razon_social }}</td>
                            <td>{{ cliente.email or '-' }}</td>
                            <td>{{ cliente.telefono or '-' }}</td>
                            <td>{{ cliente.giro or '-' }}</td>
                            <td>{{ cliente.banco or '-' }}</td>
                            <td>{% if cliente.activo == 1 or cliente.activo == True %}<span class="badge bg-success">Activo</span>{% else %}<span class="badge bg-secondary">Inactivo</span>{% endif %}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info" data-action="ver" data-rut="{{ cliente.rut }}" onclick="verCliente('{{ cliente.rut }}'); return false;" title="Ver"><i class="fas fa-eye"></i></button>
                                    <button type="button" class="btn btn-outline-warning" data-action="editar" data-rut="{{ cliente.rut }}" onclick="editarCliente('{{ cliente.rut }}'); return false;" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button type="button" class="btn btn-outline-success" data-action="toggle" data-rut="{{ cliente.rut }}" onclick="toggleEstado('{{ cliente.rut }}'); return false;" title="{% if cliente.activo == 1 or cliente.activo == True %}Desactivar{% else %}Activar{% endif %}"><i class="fas fa-toggle-{% if cliente.activo == 1 or cliente.activo == True %}on{% else %}off{% endif %}"></i></button>
                                    <button type="button" class="btn btn-outline-danger" data-action="eliminar" data-rut="{{ cliente.rut }}" onclick="eliminarCliente('{{ cliente.rut }}'); return false;" title="Eliminar"><i class="fas fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="sinResultados" class="text-center p-5 text-muted" style="display: none;">
                    <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                    <p class="fs-5">No hay clientes que coincidan con tu búsqueda</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Nuevo/Editar Cliente -->
    <div class="modal fade" id="modalClienteNuevo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-600">
                        <i class="fas fa-user-plus"></i> <span id="modalTitulo">Nuevo Cliente</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-4">
                    <form id="formCliente">
                        <!-- RUT y Razón Social -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">RUT *</label>
                                <input type="text" class="form-control" id="clienteRut" 
                                       placeholder="12.345.678-9" required>
                                <small class="text-muted">Formato: XX.XXX.XXX-X</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Razón Social *</label>
                                <input type="text" class="form-control" id="clienteRazonSocial" 
                                       placeholder="Nombre de la empresa" required>
                            </div>
                        </div>

                        <!-- Email y Teléfono -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">Email *</label>
                                <input type="email" class="form-control" id="clienteEmail" 
                                       placeholder="contacto@empresa.com" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Teléfono</label>
                                <input type="tel" class="form-control" id="clienteTelefono" 
                                       placeholder="+56 9 XXXX XXXX">
                            </div>
                        </div>

                        <!-- Giro y Dirección -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">Giro</label>
                                <input type="text" class="form-control" id="clienteGiro" 
                                       placeholder="Ej: Tecnología, Software...">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Dirección</label>
                                <input type="text" class="form-control" id="clienteDireccion" 
                                       placeholder="Calle y número">
                            </div>
                        </div>

                        <!-- Comuna y Banco -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-500">Comuna</label>
                                <input type="text" class="form-control" id="clienteComuna" 
                                       placeholder="Ej: Santiago">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-500">Banco</label>
                                <select class="form-select" id="clienteBanco">
                                    <option value="">Seleccionar banco...</option>
                                    {% for banco in bancos %}
                                    <option value="{{ banco }}">{{ banco }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Cuenta Corriente -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-500">Número de Cuenta Corriente</label>
                                <input type="text" class="form-control" id="clienteCuentaCorriente" 
                                       placeholder="Ej: 1234567890">
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="clienteActivo" checked>
                                    <label class="form-check-label" for="clienteActivo">
                                        <strong>Cliente Activo</strong>
                                    </label>
                                    <small class="d-block text-muted mt-1">Desactiva el cliente para ocultarlo de operaciones normales</small>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-500">Observaciones</label>
                                <textarea class="form-control" id="clienteObservaciones" rows="3" 
                                          placeholder="Notas adicionales sobre el cliente..."></textarea>
                            </div>
                        </div>

                        <!-- Alertas -->
                        <div id="alertasFormulario"></div>

                        <!-- Botones -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> <span id="btnGuardarTexto">Guardar Cliente</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Detalles del Cliente -->
    <div class="modal fade" id="modalVerCliente" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-light border-0">
                    <h5 class="modal-title fw-600">
                        <i class="fas fa-user-circle"></i> Detalles del Cliente
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body p-4">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">RUT</label>
                            <p class="mb-0" id="verRut">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Razón Social</label>
                            <p class="mb-0" id="verRazonSocial">-</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Email</label>
                            <p class="mb-0" id="verEmail">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Teléfono</label>
                            <p class="mb-0" id="verTelefono">-</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Giro</label>
                            <p class="mb-0" id="verGiro">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Banco</label>
                            <p class="mb-0" id="verBanco">-</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Cuenta Corriente</label>
                            <p class="mb-0" id="verCuentaCorriente">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted small fw-500">Dirección</label>
                            <p class="mb-0" id="verDireccion">-</p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <label class="text-muted small fw-500">Observaciones</label>
                            <p class="mb-0" id="verObservaciones">-</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/clientes.js', _t=12345) }}"></script>
    {% endblock %}
</body>
</html>